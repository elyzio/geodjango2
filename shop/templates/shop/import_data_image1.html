{% extends 'main/layout.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block css_styles %}
{% endblock css_styles %}

{% block contents %}
<div class="container mt-5">
    <div class="container">
        <header>
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}" class="link-dark link-underline-opacity-0">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'shop-list' %}" class="link-dark link-underline-opacity-0">Shop List</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Import Images (Folder)</li>
                </ol>
            </nav>
        </header>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div id="divmessage" class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="alert alert-info" role="alert">
        <h6><strong>File Requirements:</strong></h6>
        <ul class="mb-2">
            <li><strong>Data File:</strong> CSV (.csv) or Excel (.xlsx, .xls)</li>
            <li><strong>Images:</strong> PNG, JPG, JPEG, GIF format</li>
<<<<<<< HEAD
            <li><strong>Required columns:</strong> shop_name, image_name, image_type, center, phone</li>
=======
            <li><strong>Required columns:</strong> shop_name, center, phone, image_name, image_type</li>
            <li><strong>image_type:</strong> FIX, UPDATE, ID</li>
>>>>>>> 5962d5a21c78a74393bab505c7ffd8ce05105852
        </ul>
        <p class="mb-0"><strong>Process:</strong> Upload data file + image files → Preview → Confirm import</p>
        <p class="mb-0">Download template: <a target="_blank" href="{% static 'downloadFile/image-template.csv' %}">CSV Template</a></p>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Import Images from Folder</h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="previewForm">
                {% csrf_token %}
                {{ form.as_p }}
                <input type="hidden" name="action" value="preview">
                <button type="submit" class="btn btn-primary btn-sm">Preview Import</button>
            </form>
        </div>
    </div>

    {% if preview_data %}
    <div class="card mt-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Preview Results</h5>
                <div>
                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="confirm">
                        <button type="submit" class="btn btn-success btn-sm" 
                                {% if not preview_data|length %}disabled{% endif %}>
                            Confirm Import ({{ preview_data|length }} items)
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-bordered table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Row</th>
                            <th>Shop Name</th>
                            <th>Center</th>
                            <th>Phone</th>
                            <th>Shop Found</th>
                            <th>Image Name</th>
                            <th>Image Found</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Ready</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in preview_data %}
                        <tr class="{% if row.shop_found == '✅' and row.image_found == '✅' %}table-success{% elif row.shop_found == '❌' or row.image_found == '❌' %}table-warning{% endif %}">
                            <td>{{ row.row_number|default:forloop.counter }}</td>
                            <td>{{ row.shop_name }}</td>
                            <td>{{ row.center_name|default:'-' }}</td>
                            <td>{{ row.phone|default:'-' }}</td>
                            <td>{{ row.shop_found }}</td>
                            <td>{{ row.image_name }}</td>
                            <td>{{ row.image_found }}</td>
                            <td>{{ row.image_type|default:'-' }}</td>
                            <td>{{ row.size_kb|default:'-' }}</td>
                            <td>{{ row.will_create_new|default:'-' }}</td>
                            <td>{{ row.imported }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <small class="text-muted">
                    <strong>Legend:</strong>
                    <span class="badge bg-success">Green</span> = Ready to import
                    <span class="badge bg-warning">Yellow</span> = Issues found (will be skipped)
                    <br><strong>Note:</strong> Django automatically renames files with duplicate names to avoid conflicts.
                </small>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock contents %}


{% block scripts %}
<script>
$(document).ready(function() {
    // Add file type change handler
    $('#id_file_type').change(function() {
        if ($(this).val() === 'excel') {
            $('#id_sheet_name').closest('.form-group, p').show();
        } else {
            $('#id_sheet_name').closest('.form-group, p').hide();
        }
    }).trigger('change');
});
</script>
{% endblock scripts %}