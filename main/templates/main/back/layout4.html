{% extends 'main/layout.html' %}
{% load static %}
{% block css_styles %}
<style>
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f8f9fa;
    }
    #main-container {
        display: flex;
        overflow: hidden;
        position: relative;
        height: 75vh;
    }
    #map {
        flex: 1;
        z-index: 0;
        height: 100%;
        border-radius: 8px;
    }
    .shop-panel {
        width: 300px;
        position: absolute;
        top: 0;
        left: 0;
        height: 75vh;
        background: white;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        transform: translateX(-100%);
        transition: transform 0.4s ease;
        z-index: 1000;
        border-radius: 8px 0 0 8px;
    }
    .shop-panel.show {
        transform: translateX(0);
    }
    .shop-panel-end {
        position: absolute;
        top: 0;
        right: 0;
        transform: translateX(100%);
        width: 300px;
        height: 75vh;
        z-index: 1000;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.4s ease;
        background-color: white;
        overflow-y: auto;
        border-radius: 0 8px 8px 0;
    }
    .shop-panel-end.show {
        transform: translateX(0);
    }
    #shop-images img {
        max-width: 350px;
        height: auto;
        object-fit: cover;
        border-radius: 8px;
    }
    #shop-details table th {
        width: 40%;
    }
    .image-scroll {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding-bottom: 10px;
    }
    .image-scroll img {
        height: 150px;
        border-radius: 8px;
        object-fit: cover;
        flex-shrink: 0;
        transition: transform 0.2s;
    }
    #modalImage {
        transition: opacity 0.3s ease-in-out;
        opacity: 1;
    }
    #modalImage.fade-out {
        opacity: 0;
    }
    .breadcrumb-item a {
        color: #007bff;
    }
    .btn-toggle-list {
        background: #007bff;
        border: none;
        color: white;
        border-radius: 4px;
        transition: background 0.3s;
    }
    .btn-toggle-list:hover {
        background: #0056b3;
    }
    .list-group-item {
        border: none;
        padding: 10px 15px;
    }
    .list-group-item:hover {
        background: #e2e6ea;
    }
    @media (max-width: 768px) {
        #main-container {
            flex-direction: column;
        }
        .shop-panel {
            width: 100%;
            height: auto;
        }
        .shop-panel-end {
            width: 100%;
            height: auto;
        }
    }
</style>
{% endblock css_styles %}
{% block contents %}
<main class="container-fluid mt-5">
    <div class="container">
        <header>
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'home' %}" class="link-dark">Home</a>
                    </li>
                </ol>
            </nav>
        </header>
        <form id="shop-filter-form" class="d-flex justify-content-between mb-4">
            <select id="shop-filter" class="form-select rounded-0">
                <option value="">Select Center</option>
                {% for m in mun %}
                <option value="{{m.id}}">{{m.name}}</option>
                {% endfor %}
            </select>
            <select name="kind-banner" class="form-select rounded-0" id="kind-banner">
                <option value="">Select Banner Type</option>
                <option value="big_banner_frame">Big Banner with Frame</option>
                <option value="small_banner">Small Banner</option>
                <option value="no_info">No Banner Information</option>
            </select>
            <button class="btn btn-sm btn-toggle-list" type=""><i class="bi bi-search"></i></button>
        </form>
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span class="fw-bold">Map</span>
                <button id="toggle-shop-list" class="btn btn-sm btn-toggle-list">
                    Show List
                </button>
            </div>
            <div id="main-container">

                <div id="shop-details" class="shop-panel p-3">
                    <div class="d-flex align-items-center mb-3 bg-primary text-white p-2 rounded">
                        <button onclick="document.getElementById('shop-details').classList.remove('show')" class="btn border-0 rounded-4">
                            <i class="bi bi-arrow-left" style="font-size: 1.25rem; color: white;"></i>
                        </button>
                        <h6 class="ms-2 mb-0" id="detail-name-title">Shop Information</h6>
                        <a id="detail-gmaps" class="btn border-0 ms-auto" href="#" target="_blank">
                            <i class="bi bi-sign-turn-right" style="font-size: 1.25rem; color: white;"></i>
                        </a>
                    </div>
                    <div id="shopCarousel" class="carousel slide">
                        <div class="carousel-inner" id="shop-carousel-inner"></div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#shopCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#shopCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>
                    <div id="image-count-panel" class="text-end text-muted mt-1"></div>
                    <div class="p-3">
                        <div class="mb-2">
                            <div class="text-muted small">Owner</div>
                            <div id="detail-owner" class="fw-medium text-body"></div>
                        </div>
                        <div class="mb-2">
                            <div class="text-muted small">Contact</div>
                            <div id="detail-contact" class="fw-medium text-body"></div>
                        </div>
                        <div class="mb-2">
                            <div class="text-muted small">Address</div>
                            <div id="detail-location" class="fw-medium text-body"></div>
                        </div>
                        <div class="mb-2">
                            <div class="text-muted small">Kind of Banner</div>
                            <div id="kind-banner" class="fw-medium text-body"></div>
                        </div>
                        <div class="mb-2">
                            <div class="text-muted small">Banner Dimension</div>
                            <div id="dimension-banner" class="fw-medium text-body"></div>
                        </div>
                        <div class="mb-2">
                            <div class="text-muted small">Kind of Channel</div>
                            <div id="kind-channel" class="fw-medium text-body"></div>
                        </div>
                    </div>
                </div>
                
                <div id="map" class="rounded-end"></div>
                
                <div id="shop-list-panel" class="shop-panel-end p-3">
                    <h5 class="d-flex justify-content-between align-items-center">
                        Shops
                        <button id="close-shop-list" class="btn btn-sm btn-outline-secondary">&times;</button>
                    </h5>
                    <input type="text" id="shop-search-input" class="form-control mb-2 rounded" placeholder="Search shop name..." />
                    <ul id="shop-list" class="list-group list-group-flush"></ul>
                </div>
                
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">Marker:</h6>
                <ul class="list-unstyled">
                    <li class="d-flex align-items-center mb-2">
                        <img src="{% static 'map/icon/icon-marker-large.png' %}" alt="Big banner with frame" class="me-2" style="width: 24px;">
                        <span>Big banner with frame</span>
                    </li>
                    <li class="d-flex align-items-center mb-2">
                        <img src="{% static 'map/icon/icon-marker-small.png' %}" alt="Small banner" class="me-2" style="width: 24px;">
                        <span>Small banner</span>
                    </li>
                    <li class="d-flex align-items-center mb-2">
                        <img src="{% static 'map/icon/icon-marker-empty.png' %}" alt="No banner information" class="me-2" style="width: 24px;">
                        <span>No banner information</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</main>

<!-- Image Preview Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title"><div id="image-count-modal"></div></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body position-relative p-0">
                <div class="d-flex align-items-center justify-content-center" style="height: 500px;">
                    <button class="btn position-absolute start-0 ms-2" id="prevImage">
                        <i class="bi bi-chevron-left" style="font-size: 2rem; color: white;"></i>
                    </button>
                    <img id="modalImage" class="img-fluid" style="max-height: 90%; object-fit: contain;">
                    <button class="btn position-absolute end-0 me-2" id="nextImage">
                        <i class="bi bi-chevron-right" style="font-size: 2rem; color: white;"></i>
                    </button>
                </div>
                <div id="image-description" class="text-white text-center small bg-dark bg-opacity-50 rounded"></div>
            </div>
        </div>
    </div>
</div>

{% endblock contents %}

{% block scripts %}
<script>
    const STATIC_URLS = {
        kioskIcon: "{% static 'leaflet/images/kiosk.png' %}",
        markerLG: "{% static 'map/icon/icon-marker-large.png' %}",
        markerSM: "{% static 'map/icon/icon-marker-small.png' %}",
        markerNA: "{% static 'map/icon/icon-marker-empty.png' %}",
        defaultImage: "{% static 'img/default.png' %}"
    };
</script>
<script src="{% static 'map/map.js' %}"></script>
<script>
    let currentImageIndex = 0;
    let currentImageList = [];
    
    function openImageModal(images, index) {
        currentImageList = images;
        currentImageIndex = index;
        updateModalImage();
        const modal = new bootstrap.Modal(document.getElementById("imageModal"));
        modal.show();
    }
    
    function updateModalImage() {
        const modalImage = document.getElementById("modalImage");
        const modalCount = document.getElementById("image-count-modal");
        const modalDesc = document.getElementById("image-description");
        
        if (currentImageList.length > 0) {
            modalImage.classList.add("fade-out");
            setTimeout(() => {
                modalImage.src = currentImageList[currentImageIndex].url;
                modalImage.classList.remove("fade-out");
                modalCount.textContent = `${currentImageIndex + 1} of ${currentImageList.length}`;
                modalDesc.textContent = currentImageList[currentImageIndex].is_banner
                    ? `This shop already has a banner with the size ${currentImageList[currentImageIndex].size}.`
                    : "";
            }, 200);
        } else {
            modalCount.textContent = `0 of 0`;
            modalDesc.textContent = "";
        }
    }
    
    document.getElementById("prevImage").addEventListener("click", () => {
        if (currentImageIndex > 0) {
            currentImageIndex--;
            updateModalImage();
        }
    });
    
    document.getElementById("nextImage").addEventListener("click", () => {
        if (currentImageIndex < currentImageList.length - 1) {
            currentImageIndex++;
            updateModalImage();
        }
    });
</script>
{% endblock scripts %}